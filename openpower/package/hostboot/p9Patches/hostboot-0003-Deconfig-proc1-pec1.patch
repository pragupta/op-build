From 5f9138af4dc153179e649a8cf2467201e7d572b9 Mon Sep 17 00:00:00 2001
From: Prachi Gupta <pragupta@us.ibm.com>
Date: Mon, 20 Feb 2017 14:16:10 -0600
Subject: [PATCH] Deconfig proc1/pec1

Change-Id: I1afc0b55813e2b9ab886b31f1eb49e83a9322745
---
 src/usr/isteps/istep06/host_gard.C | 25 ++++++++++++++++++++++++-
 1 file changed, 24 insertions(+), 1 deletion(-)

diff --git a/src/usr/isteps/istep06/host_gard.C b/src/usr/isteps/istep06/host_gard.C
index 0b6464d..c879a14 100644
--- a/src/usr/isteps/istep06/host_gard.C
+++ b/src/usr/isteps/istep06/host_gard.C
@@ -5,7 +5,7 @@
 /*                                                                        */
 /* OpenPOWER HostBoot Project                                             */
 /*                                                                        */
-/* Contributors Listed Below - COPYRIGHT 2015,2016                        */
+/* Contributors Listed Below - COPYRIGHT 2015,2017                        */
 /* [+] International Business Machines Corp.                              */
 /*                                                                        */
 /*                                                                        */
@@ -60,9 +60,31 @@
   #include <diag/attn/attn.H>
 #endif
 
+using namespace TARGETING;
+
 namespace ISTEP_06
 {
 
+void witherspoon_hacks ()
+{
+    TRACFCOMP( ISTEPS_TRACE::g_trac_isteps_trace, "--witherspoon hacks--" );
+
+    for (TARGETING::TargetIterator target = TARGETING::targetService().begin();
+         target != TARGETING::targetService().end();
+         ++target)
+    {
+        if ((target->getAttr<TARGETING::ATTR_HWAS_STATE>().present) &&
+                (TARGETING::get_huid(*target) == 0x002D0004))
+        {
+                TRACFCOMP(ISTEPS_TRACE::g_trac_isteps_trace, "Prachi: Deconfiguring:0x%08x",
+                        TARGETING::get_huid(*target));
+                HWAS::theDeconfigGard().deconfigureTarget( **target,
+                        HWAS::DeconfigGard::DECONFIGURED_BY_PHYP);
+        }
+    }
+}
+
+
 void* host_gard( void *io_pArgs )
 {
     TRACDCOMP( ISTEPS_TRACE::g_trac_isteps_trace, "host_gard entry" );
@@ -205,6 +227,7 @@ void* host_gard( void *io_pArgs )
         }
     } while (0);
 
+    witherspoon_hacks();
     if (l_err)
     {
         // Create IStep error log and cross reference occurred error
-- 
1.8.2.2

